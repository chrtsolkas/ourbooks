# ourBooks

Η εφαρμογή ourBooks είναι μια απλή εφαρμογή διαχείρισης των βιβλίων μιας μικρής παρέας φίλων.


# Σχόλια για την επίλυση της τελικής εργασίας για τους εξεταστές του Mathesis

## 1. Δημιουργία αρχείου σελίδας εισαγωγής σχολίων (template) - 30%

>Προστέθηκε στον κατάλογο **views** το αρχείο **addcommentform.hbs** που περιέχει τον κώδικα για την παρουσίαση της σελίδας εισαγωγής σχολίων. Η σελίδα περιλαμβάνει μια φόρμα παρόμοια με την *addbookform.hbs* με παραμέτρους **action="/addcomment"** και **method="post"**. Σε σχέση με τη φόρμα *addbookform.hbs* στη νέα φόρμα έχει προστεθεί το πεδίο εισαγωγής σχολίου, τα πεδία τίτλου και συγγραφέα είναι disabled και έχει προστεθεί ένα hidden readonly πεδίο με τον τίτλο του βιβλίου για να γίνεται POST μαζί με τα δεδομένα της φόρμας. Επίσης, εκτός φόρμας στο τέλος της σελίδας αν δεν υπάρχουν σχόλια για το βιβλίο από άλλους χρήστες εμφανίζουμε το μήνυμα: *"Δεν υπάρχουν σχόλια άλλων χρηστών για το συγκεκριμένο βιβλίο!"*, αλλιώς εμφανίζουμε ένα πίνακα με τα ονόματα των χρηστών και τα σχόλιά τους για το βιβλίο.

## 2. Τροποποίηση στο αρχείο booklist.hbs για σύνδεση με τη σελίδα εισαγωγής σχολίων - 20%

> Στο αρχείο **booklist.hbs** προστέθηκε στην γραμμή προβολής κάθε βιλίου ένα επιπρόσθετο κουμπί δίπλα από το κουμπί διαγραφής με τίτλο **"Σχόλια"** το οποίο μας δρομολογεί στη διαδρομή **"/comment/{{this.title}}"**, δηλαδή στη διαδρομή "/comment" με παράμετρο τον τίτλο του βιλίου.

## 3. Τροποποίηση στο αρχείο routes.mjs για υποστήριξη δρομολόγησης στη νέα σελίδα εισαγωγής σχολίων - 10%

> Στο αρχείο **routes.mjs** προστέθηκαν δύο πρόσθετες διαδρομές:

```
router.get(
  '/comment/:title',
  UserController.checkIfAuthenticated,
  BookController.showBookComments
)

router.post(
  '/addcomment',
  UserController.checkIfAuthenticated,
  BookController.updateBookComment,
  BookController.showBookList
)
```
>Στην πρώτη διαδρομή οδηγούμαστε όταν ο χρήστης πατήσει το κουμπί **"Σχόλια"** για κάποιο βιβλίο της λίστας βιλίων του. Σε αυτή την περίπτωση ελέγχουμε αν ο χρήστης είναι αυθεντικοποιημένος και εμφανίζουμε τη σελίδα με τη φόρμα εισαγωγής σχολίων  **addcommentform.hbs**

> Στη δεύτερη διαδρομή οδηγούμαστε όταν ο χρήστης υποβάλει το σχόλιο του στη φόρμα εισαγωγής σχολίων  **addcommentform.hbs**. Σε αυτή την περίπτωση ελέγχουμε αν ο χρήστης είναι αυθεντικοποιημένος, ενημερώνουμε το σχόλιο του χρήστη για το βιβλίο και εμφανίζουμε τη λίστα βιβλίων.

## 4. Τροποποίηση του αρχείου booklist_model.mjs με προσθήκη της συνάρτησης σχολίου - 10%

> Στο αρχείο **booklist_model.mjs** έχουν προστεθεί τέσσερις νέες συναρτήσεις:
1. *async function findBook(bookTitle)*: δέχεται ως όρισμα τον τίτλο του βιβλίου και επιστρέφει το στιγμιότυπο βιβλίου με τον συγκεκριμένο τίτλο.
2. *async function loadUserComment(book, username)*: δέχεται ως ορίσματα ένα στιγμιότυπο βιβλίου και το όνομα του χρήστη και επιστρέφει ένα στιγμιότυπο bookUser από τον πίνακα BookUser που αναφέρεται στον τίτλο του βιβλίου και στο όνομα χρήστη που δόθηκαν.
3. *async function loadOtherComments(book, username)*: δέχεται ως ορίσματα ένα στιγμιότυπο βιβλίου και το όνομα του χρήστη και επιστρέφει τα γνωρίσματα "UserName" και "comment" από όλες τις εγγραφές του πίνακα BookUser στις οποίες ο τίτλος βιβλίου είναι αυτός που δόθηκε ως όρισμα, το σχόλιο δεν είναι κενό και ούτε NULL και το όνομα χρήστη είναι διαφορετικό από αυτό που δόθηκε ως όρισμα. Άρα επιστρέφει μια λίστα με τα ονόματα των άλλων χρηστών και τα σχόλιά τους για το συγκεκριμένο βιβλίο.
4. *async function updateBookComment(bookComment, bookTitle, username)*: δέχεται ως όρισμα το σχόλιο και τον τίτλο του βιβλίου και το όνομα χρήστη και ενημερώνει στον πίνακα BookUser το σχόλιο της εγγραφής που αντιστοιχεί στον τίτλο βιβλίου και στον συγκεκριμένο χρήστη.

> Για να υλοποιηθούν οι παραπάνω συναρτήσεις πρέπει να κάνουμε import τον πίνακα BookUser από τη βάση δεδομένων και την Op από το sequelize (για να δημιουργούμε ερωτήματα με τελεστές στην έκφραση WHERE).


## 5. Τροποποίηση του αρχείου booklist_controller.mjs με προσθήκη της συνάρτησης κλήσης της αντίστοιχης συνάρτησης του μοντέλου για εισαγωγή των σχολίων στη βάση δεδομένων - 10%

> Στο αρχείο **booklist_controller.mjs** προστέθηκαν δύο νέα middleware:
1. *async function showBookComments(req, res, next)*: Αρχικά βρίσκει αν το βιβλίο υπάρχει στη βάση δεδομένων (χρησιμοποιώντας την BookList.findBook με παράμετρο τον τίτλο του βιβλίου). Μετά βρίσκει το σχόλιο του ενεργού χρήστη για το βιβλίο (χρησιμοποιώντας την BookList.loadUserComment με παραμέτρους το βιβλίο και το όνομα του ενεργού χρήστη). Στη συνέχεια βρίσκει τα σχόλια άλλων χρηστών για το συγκεκριμένο βιβλίο (χρησιμοποιώντας την BookList.loadOtherComments με παραμέτρους το βιβλίο και το όνομα του ενεργού χρήστη). Τέλος φορτώνει τη σελίδα εισαγωγής σχολίων (template) με παραμέτρους τον τίτλο και τον συγγραφέα του βιβλίου, το σχόλιο και το όνομα του ενεργού χρήστη και τη λίστα σχολίων των άλλων χρηστών για το συγκεκριμένο βιβλίο.
2. *const updateBookComment = async (req, res, next)*: Ενημερώνει το σχόλιο του ενεργού χρήστη για το βιβλίο (χρησιμοποιώντας την BookList.updateBookComment με παραμέτρους το σχόλιο, τον τίτλο του βιβλίου και το όνομα του ενεργού χρήστη). 

## 6. Ανάρτηση της εφαρμογής σε δημόσια πλατφόρμα φιλοξενίας εφαρμογών όπως το fly.io ή το heroku.com - 20%

>Η εφαρμογή έχει δημοσιευτεί στο [Heroku](https://www.heroku.com/) και μπορείτε να την δοκιμάσετε στον ακόλουθο σύνδεσμο [ourBooks@Heroku](https://our-books-app.herokuapp.com/)!

## Εκτέλεση σε τοπικό τερματικό

Για την εκτέλεση της εφαρμογής τοπικά πρέπει να εφαρμοστούν οι ακόλουθες αλλαγές:

>Πρέπει να αφαιρεθεί ο σχολιασμός των ακόλουθων γραμμών κώδικά και να συμπληρωθούν κατάλληλα οι τιμές (π.χ. οι τρέχουσες τιμές απαιτούν να έχει κατασκευαστεί μια βάση δεδομένων με όνομα *myBooks2* και ο χρήστης *postgres* να έχει δικαιώματα σε αυτή, το σύστημα διαχείρησης της βάσης δεδομένων να είναι η *PostgreSQL* και να εκτελείται *τοπικά* στη θύρα *5432*) στο αρχείο **bookList_seq_PostgreSQL.mjs**:

```{JS}
// host: 'localhost',
// port: '5432',
// dialect: 'postgres',
// username: 'postgres',
// database: 'myBooks2',
// logging: false,
// define: {
//     timestamps: false,
//     freezeTableName: true
// }

```
>Πρέπει να σχολιαστούν οι ακόλουθες γραμμές κώδικα στο ίδιο αρχείο:

```
process.env.DATABASE_URL,
```
```
    dialect: 'postgres',
    dialectOptions: {
        ssl: {
            require: true,
            rejectUnauthorized: false
        }
    },
    logging: false,
    define: {
        timestamps: false,
        freezeTableName: true
    }
```


>Πρέπει να μετονομάσετε το αρχείο **.env-example** σε **.env**.

>Για να ξεκινήσει η εφαρμογή τοπικά εκτελέστε τις ακόλουθες εντολές στο τερματικό σας:

```
npm install
node app.mjs
```
>Η εφαρμογή είναι προσβάσιμη τοπικά στη διεύθυνση [localhost:3000](http://localhost:3000)

>Η εφαρμογή έχει δοκιμαστεί τοπικά με τη node.js 18.x και με βάση δεδομένων PostgreSQL 14.5.